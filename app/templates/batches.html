{% extends "base.html" %}

{% block title %}Загрузки - ThoraxAI{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-history"></i> История загрузок</h2>
            <p class="text-muted">Список всех загруженных батчей исследований</p>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="searchInput" placeholder="Поиск по дате...">
            </div>
        </div>
        <div class="col-md-6 text-end">
            <a href="/" class="btn btn-primary">
                <i class="fas fa-plus"></i> Новая загрузка
            </a>
        </div>
    </div>

    <!-- Список батчей -->
    <div id="batchesList" class="row">
        <!-- Батчи будут загружены через JavaScript -->
    </div>

    <!-- Пагинация -->
    <nav aria-label="Пагинация" class="mt-4">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- Пагинация будет создана через JavaScript -->
        </ul>
    </nav>

    <!-- Загрузка -->
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
        <p class="mt-2">Загрузка данных...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    const pageSize = 12;
    let allBatches = [];
    let filteredBatches = [];

    const batchesList = document.getElementById('batchesList');
    const pagination = document.getElementById('pagination');
    const loading = document.getElementById('loading');
    const searchInput = document.getElementById('searchInput');

    // Загрузка батчей
    async function loadBatches() {
        try {
            loading.style.display = 'block';
            batchesList.innerHTML = '';

            const response = await fetch('/api/v1/studies/batches');
            if (!response.ok) {
                throw new Error('Ошибка загрузки данных');
            }

            allBatches = await response.json();
            filteredBatches = [...allBatches];

            renderBatches();
            renderPagination();

        } catch (error) {
            console.error('Ошибка:', error);
            batchesList.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Ошибка при загрузке данных: ${error.message}
                    </div>
                </div>
            `;
        } finally {
            loading.style.display = 'none';
        }
    }

    // Отображение батчей
    function renderBatches() {
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const batchesToShow = filteredBatches.slice(startIndex, endIndex);

        if (batchesToShow.length === 0) {
            batchesList.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle"></i>
                        Батчи не найдены
                    </div>
                </div>
            `;
            return;
        }

        batchesList.innerHTML = batchesToShow.map(batch => createBatchCard(batch)).join('');
    }

    // Создание карточки батча
    function createBatchCard(batch) {
        const uploadDate = new Date(batch.upload_date);
        const formattedDate = uploadDate.toLocaleString('ru-RU');

        const successRate = batch.total_studies > 0 ?
            Math.round((batch.processed_studies / batch.total_studies) * 100) : 0;

        const statusBadge = getStatusBadge(batch);

        return `
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card h-100 batch-card clickable-card" onclick="window.location.href='/batches/${batch.id}'">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>
                            ${formattedDate}
                        </h6>
                        ${statusBadge}
                    </div>
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="text-center mb-1">
                                    <small class="text-muted">Исследований</small>
                                </div>
                                <div class="text-center">
                                    <div class="h5 mb-0 text-primary fw-bold">${batch.total_studies}</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center mb-1">
                                    <small class="text-muted">Успешность</small>
                                </div>
                                <div class="text-center">
                                    <div class="h5 mb-0 text-success fw-bold">${successRate}%</div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <small class="text-muted">Обработано:</small>
                                <span class="fw-bold text-success">${batch.processed_studies}</span>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Ошибок:</small>
                                <span class="fw-bold text-danger">${batch.failed_studies}</span>
                            </div>
                        </div>

                        <div class="mt-auto">
                            <button class="btn btn-outline-success btn-sm w-100"
                                    onclick="event.stopPropagation(); downloadReport(${batch.id})"
                                    title="Скачать отчет">
                                <i class="fas fa-download me-2"></i>
                                Скачать отчет
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Получение бейджа статуса
    function getStatusBadge(batch) {
        if (batch.failed_studies === 0) {
            return '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Успешно</span>';
        } else if (batch.processed_studies > 0) {
            return '<span class="badge bg-warning"><i class="fas fa-exclamation-triangle me-1"></i>Частично</span>';
        } else {
            return '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>Ошибка</span>';
        }
    }

    // Скачивание отчета
    async function downloadReport(batchId) {
        try {
            const response = await fetch(`/api/v1/studies/batches/${batchId}/report`);
            if (!response.ok) {
                throw new Error('Ошибка при скачивании отчета');
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `batch_report_${batchId}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

        } catch (error) {
            alert('Ошибка при скачивании отчета: ' + error.message);
        }
    }

    // Сделаем функцию глобальной
    window.downloadReport = downloadReport;

    // Отображение пагинации
    function renderPagination() {
        const totalPages = Math.ceil(filteredBatches.length / pageSize);

        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let paginationHTML = '';

        // Предыдущая страница
        paginationHTML += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;

        // Номера страниц
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }

        // Следующая страница
        paginationHTML += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;

        pagination.innerHTML = paginationHTML;
    }

    // Смена страницы
    function changePage(page) {
        const totalPages = Math.ceil(filteredBatches.length / pageSize);
        if (page < 1 || page > totalPages) return;

        currentPage = page;
        renderBatches();
        renderPagination();

        // Прокрутка к началу списка
        batchesList.scrollIntoView({ behavior: 'smooth' });
    }

    // Сделаем функцию глобальной
    window.changePage = changePage;

    // Фильтрация батчей
    function filterBatches() {
        const searchTerm = searchInput.value.toLowerCase();

        filteredBatches = allBatches.filter(batch => {
            const uploadDate = new Date(batch.upload_date).toLocaleString('ru-RU').toLowerCase();
            return uploadDate.includes(searchTerm);
        });

        currentPage = 1;
        renderBatches();
        renderPagination();
    }

    // Обработчики событий
    searchInput.addEventListener('input', filterBatches);

    // Загружаем данные при загрузке страницы
    loadBatches();
});
</script>

<style>
.batch-card {
    transition: all 0.3s ease;
    border: 1px solid transparent;
}

.batch-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(12, 93, 116, 0.15);
}

[data-theme="dark"] .batch-card:hover {
    box-shadow: 0 8px 25px rgba(233, 236, 240, 0.1);
    border-color: #e9ecef;
}

.batch-card .card-body {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.batch-card .mt-auto {
    margin-top: auto !important;
    padding-top: 1rem;
}
</style>
{% endblock %}
